<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board - ESH Operations Hub</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="kanban-container">
        <div class="kanban-header">
            <div class="kanban-title">
                <h2><i class="fas fa-columns"></i> Kanban Board</h2>
                <div class="project-info">
                    <span id="currentProjectName">Select a project</span>
                </div>
            </div>
            <div class="kanban-actions">
                <button class="btn btn-primary" onclick="parent.openTaskModal()">
                    <i class="fas fa-plus"></i> Add Task
                </button>
                <button class="btn btn-secondary" onclick="refreshKanban()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
        </div>

        <div class="kanban-board" id="kanbanBoard">
            <div class="kanban-column" data-stage="backlog">
                <div class="column-header">
                    <h3>
                        <i class="fas fa-inbox"></i>
                        Backlog
                        <span class="task-count" data-stage="backlog">0</span>
                    </h3>
                    <button class="add-task-btn" onclick="parent.openTaskModal('backlog')">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="tasks-container" data-stage="backlog" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                    <!-- Tasks will be loaded here -->
                </div>
            </div>

            <div class="kanban-column" data-stage="planning">
                <div class="column-header">
                    <h3>
                        <i class="fas fa-clipboard-list"></i>
                        Planning
                        <span class="task-count" data-stage="planning">0</span>
                    </h3>
                    <button class="add-task-btn" onclick="parent.openTaskModal('planning')">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="tasks-container" data-stage="planning" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                    <!-- Tasks will be loaded here -->
                </div>
            </div>

            <div class="kanban-column" data-stage="in_progress">
                <div class="column-header">
                    <h3>
                        <i class="fas fa-spinner"></i>
                        In Progress
                        <span class="task-count" data-stage="in_progress">0</span>
                    </h3>
                    <button class="add-task-btn" onclick="parent.openTaskModal('in_progress')">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="tasks-container" data-stage="in_progress" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                    <!-- Tasks will be loaded here -->
                </div>
            </div>

            <div class="kanban-column" data-stage="review">
                <div class="column-header">
                    <h3>
                        <i class="fas fa-search"></i>
                        Review
                        <span class="task-count" data-stage="review">0</span>
                    </h3>
                    <button class="add-task-btn" onclick="parent.openTaskModal('review')">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="tasks-container" data-stage="review" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                    <!-- Tasks will be loaded here -->
                </div>
            </div>

            <div class="kanban-column" data-stage="done">
                <div class="column-header">
                    <h3>
                        <i class="fas fa-check-circle"></i>
                        Done
                        <span class="task-count" data-stage="done">0</span>
                    </h3>
                    <button class="add-task-btn" onclick="parent.openTaskModal('done')">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="tasks-container" data-stage="done" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                    <!-- Tasks will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentProject = null;
        let tasks = [];
        let draggedTask = null;

        // Initialize kanban when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeKanban();
            startRealTimeUpdates();
        });

        function initializeKanban() {
            // Get current project from parent
            if (window.parent.currentProject) {
                currentProject = window.parent.currentProject;
                document.getElementById('currentProjectName').textContent = currentProject.name;
            }
            
            loadTasks();
            setupEventListeners();
        }

        function setupEventListeners() {
            // Listen for project changes from parent
            window.addEventListener('message', function(event) {
                if (event.data.type === 'projectChanged') {
                    currentProject = event.data.project;
                    document.getElementById('currentProjectName').textContent = currentProject.name;
                    loadTasks();
                }
            });
        }

        async function loadTasks() {
            try {
                showLoading(true);
                const response = await fetch(`${window.parent.API_BASE_URL}/api/tasks?project_id=${currentProject?.id || ''}`, {
                    headers: {
                        'Authorization': `Bearer ${window.parent.getAuthToken()}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load tasks');
                
                const data = await response.json();
                tasks = data.tasks || [];
                renderKanbanBoard();
                updateTaskCounts();
            } catch (error) {
                console.error('Error loading tasks:', error);
                showError('Failed to load tasks');
            } finally {
                showLoading(false);
            }
        }

        function renderKanbanBoard() {
            const stages = ['backlog', 'planning', 'in_progress', 'review', 'done'];
            
            stages.forEach(stage => {
                const container = document.querySelector(`.tasks-container[data-stage="${stage}"]`);
                container.innerHTML = '';
                
                const stageTasks = tasks.filter(task => task.stage === stage);
                stageTasks.sort((a, b) => a.position - b.position);
                
                stageTasks.forEach(task => {
                    container.appendChild(createTaskCard(task));
                });
            });
        }

        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = `task-card priority-${task.priority}`;
            card.draggable = true;
            card.dataset.taskId = task.id;
            card.dataset.stage = task.stage;
            
            const priorityColors = {
                low: '#4caf50',
                medium: '#ff9800',
                high: '#f44336',
                urgent: '#9c27b0'
            };

            card.innerHTML = `
                <div class="task-header">
                    <span class="task-priority" style="background-color: ${priorityColors[task.priority]}"></span>
                    <span class="task-id">#${task.id}</span>
                </div>
                <div class="task-title" onclick="editTask(${task.id})">${task.title}</div>
                <div class="task-description">${task.description || ''}</div>
                ${task.assignee ? `
                    <div class="task-assignee">
                        <img src="https://picsum.photos/seed/${task.assignee.username}/24/24" alt="${task.assignee.full_name}">
                        <span>${task.assignee.full_name}</span>
                    </div>
                ` : ''}
                ${task.due_date ? `
                    <div class="task-due-date">
                        <i class="fas fa-clock"></i>
                        ${formatDate(task.due_date)}
                    </div>
                ` : ''}
                <div class="task-footer">
                    <div class="task-hours">
                        ${task.estimated_hours ? `<i class="fas fa-hourglass-half"></i> ${task.estimated_hours}h` : ''}
                        ${task.actual_hours ? ` / ${task.actual_hours}h` : ''}
                    </div>
                    <div class="task-actions">
                        <button onclick="editTask(${task.id})" class="action-btn">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTask(${task.id})" class="action-btn delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            // Add drag event listeners
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);

            return card;
        }

        function handleDragStart(e) {
            draggedTask = e.target;
            e.target.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        async function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedTask && draggedTask !== e.target) {
                const targetContainer = e.target.closest('.tasks-container');
                if (targetContainer) {
                    const newStage = targetContainer.dataset.stage;
                    const taskId = draggedTask.dataset.taskId;
                    
                    await updateTaskStage(parseInt(taskId), newStage);
                    
                    // Move the card to the new container
                    targetContainer.appendChild(draggedTask);
                    draggedTask.dataset.stage = newStage;
                    
                    updateTaskCounts();
                }
            }

            return false;
        }

        async function updateTaskStage(taskId, newStage) {
            try {
                const response = await fetch(`${window.parent.API_BASE_URL}/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.parent.getAuthToken()}`
                    },
                    body: JSON.stringify({
                        stage: newStage
                    })
                });

                if (!response.ok) throw new Error('Failed to update task');
                
                // Update local task data
                const taskIndex = tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    tasks[taskIndex].stage = newStage;
                }

                // Send notification to parent
                window.parent.postMessage({
                    type: 'taskUpdated',
                    task: tasks[taskIndex]
                }, '*');

            } catch (error) {
                console.error('Error updating task stage:', error);
                showError('Failed to update task');
            }
        }

        function updateTaskCounts() {
            const stages = ['backlog', 'planning', 'in_progress', 'review', 'done'];
            
            stages.forEach(stage => {
                const count = tasks.filter(task => task.stage === stage).length;
                const countElement = document.querySelector(`.task-count[data-stage="${stage}"]`);
                if (countElement) {
                    countElement.textContent = count;
                }
            });
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                window.parent.postMessage({
                    type: 'editTask',
                    task: task
                }, '*');
            }
        }

        async function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                try {
                    const response = await fetch(`${window.parent.API_BASE_URL}/api/tasks/${taskId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${window.parent.getAuthToken()}`
                        }
                    });

                    if (!response.ok) throw new Error('Failed to delete task');
                    
                    // Remove task from local array
                    tasks = tasks.filter(t => t.id !== taskId);
                    
                    // Remove card from DOM
                    const card = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
                    if (card) {
                        card.remove();
                    }
                    
                    updateTaskCounts();
                    
                } catch (error) {
                    console.error('Error deleting task:', error);
                    showError('Failed to delete task');
                }
            }
        }

        function refreshKanban() {
            loadTasks();
        }

        function showLoading(show) {
            window.parent.showLoading(show);
        }

        function showError(message) {
            window.parent.showError(message);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === tomorrow.toDateString()) {
                return 'Tomorrow';
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
        }

        // Real-time updates
        function startRealTimeUpdates() {
            setInterval(() => {
                if (currentProject) {
                    loadTasks();
                }
            }, 5000); // Update every 5 seconds
        }
    </script>
</body>
</html>